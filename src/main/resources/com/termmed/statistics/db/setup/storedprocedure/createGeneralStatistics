drop procedure if exists createGeneralStatistics;

CREATE PROCEDURE createGeneralStatistics()
   MODIFIES SQL DATA
 BEGIN ATOMIC
 declare  totCpt INTEGER;
select count(*) into totCpt
from s_concepts c
where c.active=1;

truncate table cptRootLevel;

insert into cptRootLevel 
select d.conceptId as id, d.term , convert(0,  integer) as Concepts, convert(0,  decimal(5,2)) as PercentOfTotal
,convert(0,  decimal(5,2)) as PercentOfSD, convert(0,  integer) as Descriptions,convert(0,  integer) as Relationships
from s_descriptions d 
where d.conceptId=138875005 
and d.active=1
and d.typeId=900000000000003001;

Update cptRootLevel 
set Concepts=totCpt ;


Update cptRootLevel 
set PercentOfTotal=100 ;


Update cptRootLevel 
set PercentOfSD=(100 * (select count(*) 
						from s_concepts c
						where c.active=1
						and c.definitionStatusId=900000000000073002) / totCpt);


Update cptRootLevel 
set Descriptions=(select count(*)
					from s_concepts t  
					inner join s_descriptions d 
					on d.conceptid=t.id 
					where t.active=1
					and d.active=1);



Update cptRootLevel 
set Relationships=(select count(*)
					from s_relationships r);


truncate table cptFirstLevel;

insert into cptFirstLevel 
select r.sourceId as id, d.term , convert(0,  integer) as Concepts, convert(0,  decimal(5,2)) as PercentOfTotal
,convert(0,  decimal(5,2)) as PercentOfSD, convert(0,  integer) as Descriptions,convert(0,  integer) as Relationships
from s_statedrootdesc r 
inner join s_descriptions d on d.conceptId=r.sourceId
where d.active=1
and d.typeId=900000000000003001;

Update cptFirstLevel 
set Concepts=(select count(*) +1
				from s_tclosure_stated t 
				where t.ancestor=cptFirstLevel.id);


Update cptFirstLevel 
set PercentOfTotal=(100 * Concepts/ totCpt );


Update cptFirstLevel 
set PercentOfSD=(100 * (select count(*) 
				from s_concepts c 
				inner join s_tclosure_stated t 
				on t.descendant=c.id
				where t.ancestor=cptFirstLevel.id
				and c.active=1
				and c.definitionStatusId=900000000000073002) / Concepts);


Update cptFirstLevel 
set Descriptions=(select count(*)
					from s_tclosure_stated t  
					inner join s_descriptions d 
					on d.conceptid=t.descendant 
					where t.ancestor=cptFirstLevel.id
					and d.active=1);

Update cptFirstLevel 
set Descriptions=Descriptions + (select count(*)
					from  s_descriptions d 
					where d.conceptid=cptFirstLevel.id
					and d.active=1);

Update cptFirstLevel 
set Relationships=(select count(*)
					from s_tclosure_stated t  
					inner join s_relationships r
					on r.sourceId=t.descendant 
					where t.ancestor=cptFirstLevel.id
					and r.active=1) ;
					
Update cptFirstLevel 
set Relationships=Relationships + (select count(*)
					from  s_relationships r
					where r.sourceId=cptFirstLevel.id
					and r.active=1);

END